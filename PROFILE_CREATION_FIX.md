# Profile Creation Fix - Implementation Guide

## Problem
User registration was successful in the frontend, but profiles were not being created in Supabase due to:
1. Missing database trigger to auto-create profiles
2. RLS policies blocking INSERT operations
3. Code only tried to UPDATE profile, never INSERT

## Solution Implemented

### 1. Database Trigger & Functions (SQL Script)
Created `supabase/fix_profile_creation.sql` with:
- ‚úÖ `generate_referral_code()` function - Creates unique referral codes
- ‚úÖ `increment_referral_count()` function - Increments parent user's referral count
- ‚úÖ `handle_new_user()` trigger function - Auto-creates profile when user signs up
- ‚úÖ Trigger on `auth.users` table - Fires after user creation
- ‚úÖ RLS policies for INSERT, SELECT, UPDATE operations

### 2. Register Component Updates
Updated `src/pages/Register.tsx` with:
- ‚úÖ Explicit profile creation if trigger fails
- ‚úÖ Comprehensive error logging for debugging
- ‚úÖ Fallback referral code generation
- ‚úÖ Better error handling and user feedback

## How to Apply the Fix

### Step 1: Run SQL Script in Supabase

1. Open your Supabase Dashboard
2. Go to **SQL Editor** in the left sidebar
3. Click **"New query"**
4. Open the file: `supabase/fix_profile_creation.sql`
5. **Copy ALL the SQL code** from the file
6. **Paste it into the SQL Editor**
7. Click **"Run"** (or press Ctrl+Enter)
8. You should see "Success. No rows returned"

### Step 2: Verify Setup

Run these queries in SQL Editor to verify:

```sql
-- Check if trigger exists
SELECT * FROM pg_trigger WHERE tgname = 'on_auth_user_created';

-- Check if policies exist
SELECT * FROM pg_policies WHERE tablename = 'profiles';

-- Check if functions exist
SELECT routine_name FROM information_schema.routines 
WHERE routine_schema = 'public' 
AND routine_name IN ('generate_referral_code', 'increment_referral_count', 'handle_new_user');
```

### Step 3: Test Registration

1. Start your dev server: `npm run dev`
2. Navigate to `/register`
3. Fill out the registration form
4. Submit the form
5. Check browser console for detailed logs
6. Go to Supabase Dashboard ‚Üí **Table Editor** ‚Üí `profiles`
7. You should see the new profile! ‚úÖ

## How It Works

### Automatic Profile Creation (Trigger)
When a user signs up via `supabase.auth.signUp()`:
1. User is created in `auth.users` table
2. Trigger `on_auth_user_created` fires automatically
3. Trigger function `handle_new_user()` runs
4. Profile is created in `public.profiles` table with:
   - User ID, email, name, phone from auth metadata
   - Unique referral code generated by `generate_referral_code()`
   - Initial referral_count of 0

### Manual Profile Creation (Fallback)
If the trigger fails or doesn't exist:
1. Register component checks if profile exists (waits 500ms for trigger)
2. If profile doesn't exist, creates it explicitly
3. Uses database function to generate referral code
4. Falls back to simple code if function fails

### Referral Code Handling
- If user registers with a referral code (`?ref=CODE`):
  1. Finds parent user by referral code
  2. Updates new user's profile with `referred_by` field
  3. Increments parent's `referral_count` using `increment_referral_count()` function

## Error Logging

The Register component now includes comprehensive logging:
- üöÄ Process start
- ‚úÖ Success steps
- ‚ö†Ô∏è Warnings (fallbacks)
- ‚ùå Errors with full details

Check browser console (F12) to see detailed logs during registration.

## Troubleshooting

### Profile Still Not Created?

1. **Check RLS Policies:**
   ```sql
   SELECT * FROM pg_policies WHERE tablename = 'profiles';
   ```
   Should show policies for INSERT, SELECT, UPDATE

2. **Check Trigger:**
   ```sql
   SELECT * FROM pg_trigger WHERE tgname = 'on_auth_user_created';
   ```
   Should return one row

3. **Check Functions:**
   ```sql
   SELECT routine_name FROM information_schema.routines 
   WHERE routine_schema = 'public' 
   AND routine_name = 'handle_new_user';
   ```
   Should return the function name

4. **Check Browser Console:**
   - Look for error messages
   - Check if profile creation is being attempted
   - Verify RLS errors

### RLS Policy Errors?

If you see "new row violates row-level security policy":
- Make sure the INSERT policy exists: `"Users can insert own profile"`
- Policy should use: `WITH CHECK (auth.uid() = id)`

### Trigger Not Firing?

- Verify trigger is attached to `auth.users` table
- Check if trigger is enabled: `SELECT * FROM pg_trigger WHERE tgname = 'on_auth_user_created';`
- The manual fallback in Register.tsx should still create the profile

## Files Modified

1. ‚úÖ `supabase/fix_profile_creation.sql` - SQL script with trigger and policies
2. ‚úÖ `src/pages/Register.tsx` - Updated with explicit profile creation and logging

## Next Steps

After applying the fix:
1. Test registration with a new user
2. Verify profile appears in Supabase Table Editor
3. Test referral code functionality
4. Check that referral counts increment correctly

